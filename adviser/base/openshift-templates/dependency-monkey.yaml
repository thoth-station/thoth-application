apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: dependency-monkey
  annotations:
    description: "Thoth: Dependency Monkey"
    openshift.io/display-name: "Thoth: Adviser"
    tags: thoth,ai-stacks,dependency-monkey
    template.openshift.io/documentation-url: https://github.com/Thoth-Station/
    template.openshift.io/long-description: >
      This template defines resources needed to run dependency monkey on OpenShift.
    template.openshift.io/provider-display-name: "Red Hat, Inc."
  labels:
    app: thoth
    template: dependency-monkey
    component: dependency-monkey

parameters:
  - name: THOTH_DEPENDENCY_MONKEY_JOB_ID
    required: true
    description: A unique identifier of dependency monkey job run.
    displayName: Dependency monkey job id
  - name: THOTH_DOCUMENT_ID
    description: "A unique identifier of the resulting document in a Thoth deployment."
    displayName: "Document identifier"
    required: true
  - name: THOTH_LOG_ADVISER
    description: Log Dependency Mokney actions.
    value: INFO
  - name: THOTH_ADVISER_PLOT
    description: A path to history file to store annealing progress history.
    displayName: History plot file
    # value: "history.png"
  - name: THOTH_ADVISER_BEAM_WIDTH
    required: true
    description: Resolver's beam width to restrict memory requirements with states generated.
    displayName: Beam width
    value: "1000000"
  - name: THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT
    description: A URL to Amun API where the given stack should be inspected or - for stdout.
    value: "-"
  - name: THOTH_DEPENDENCY_MONKEY_SEED
    description: A seed to be used for generating software stack samples.
  - name: THOTH_ADVISER_DEV
    description: Consider also development dependencies.
    value: "0"
  - name: THOTH_DEPENDENCY_MONKEY_DECISION_TYPE
    description:
      A decision function that should be used for generating software stack
      samples; if omitted, all software stacks will be created.
    value: "all"
  - name: THOTH_DEPENDENCY_MONKEY_DRY_RUN
    description:
      Do not generate software stacks, just report how many software stacks
      will be generated.
    value: "0"
  - name: THOTH_DEPENDENCY_MONKEY_COUNT
    description: Limit number of software stacks generated by dependency monkey
    value: "10000"
  - name: THOTH_ADVISER_LIMIT_LATEST_VERSIONS
    description: Limit number of versions starting from latest in stacks.
    displayName: Limit latest versions
    value: "9999999"
  - name: THOTH_ADVISER_PREDICTOR
    description: Predictor to be used.
    displayName: Predictor.
    value: "AUTO"
  - name: THOTH_ADVISER_PREDICTOR_CONFIG
    description: Predictor's configuration.
    displayName: Predictor's configuration.
    value: "{}"
objects:
  - apiVersion: argoproj.io/v1alpha1
    kind: Workflow
    metadata:
      name: "${THOTH_DEPENDENCY_MONKEY_JOB_ID}"
      labels:
        app: thoth
        component: dependency-monkey
    spec:
      serviceAccountName: argo
      activeDeadlineSeconds: 3000
      ttlStrategy:
        secondsAfterCompletion: 7200
        secondsAfterSuccess: 7200
        secondsAfterFailure: 7200
      entrypoint: dependency-monkey

      metrics:
        prometheus:
          - name: status_counter
            help: "Count of workflow by status"
            labels:
              - key: name
                value: dependency-monkey
              - key: status
                value: "{{workflow.status}}"
            counter:
              value: "1"

          - name: duration_seconds_histogram
            help: "Duration of workflow when succeded"
            when: "{{workflow.status}} == Succeeded"
            labels:
              - key: name
                value: dependency-monkey
            histogram:
              buckets:
                - 5
                - 10
                - 30
                - 60
                - 120
                - 180
                - 300
                - 600
                - 900
              value: "{{workflow.duration}}"

      arguments:
        parameters:
          - name: THOTH_DEPENDENCY_MONKEY_JOB_ID
            value: "${THOTH_DEPENDENCY_MONKEY_JOB_ID}"
          - name: THOTH_DOCUMENT_ID
            value: "${THOTH_DOCUMENT_ID}"
          - name: THOTH_LOG_ADVISER
            value: "${THOTH_LOG_ADVISER}"
          - name: THOTH_ADVISER_PLOT
            value: "${THOTH_ADVISER_PLOT}"
          - name: THOTH_ADVISER_BEAM_WIDTH
            value: "${THOTH_ADVISER_BEAM_WIDTH}"
          - name: THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT
            value: "${THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT}"
          - name: THOTH_DEPENDENCY_MONKEY_SEED
            value: "${THOTH_DEPENDENCY_MONKEY_SEED}"
          - name: THOTH_ADVISER_DEV
            value: "${THOTH_ADVISER_DEV}"
          - name: THOTH_DEPENDENCY_MONKEY_DECISION_TYPE
            value: "${THOTH_DEPENDENCY_MONKEY_DECISION_TYPE}"
          - name: THOTH_DEPENDENCY_MONKEY_DRY_RUN
            value: "${THOTH_DEPENDENCY_MONKEY_DRY_RUN}"
          - name: THOTH_DEPENDENCY_MONKEY_COUNT
            value: "${THOTH_DEPENDENCY_MONKEY_COUNT}"
          - name: THOTH_ADVISER_LIMIT_LATEST_VERSIONS
            value: "${THOTH_ADVISER_LIMIT_LATEST_VERSIONS}"
          - name: THOTH_ADVISER_PREDICTOR
            value: "${THOTH_ADVISER_PREDICTOR}"
          - name: THOTH_ADVISER_PREDICTOR_CONFIG
            value: "${THOTH_ADVISER_PREDICTOR_CONFIG}"
          - name: ceph_bucket_prefix
          - name: ceph_bucket_name
          - name: ceph_host
          - name: deployment_name
      volumes:
        - name: workdir
          emptyDir: {}
      templates:
        - name: "dependency-monkey"
          archiveLocation:
            archiveLogs: true
          dag:
            tasks:
              - name: "dm"
                templateRef:
                  name: "dm"
                  template: "dm"
                continueOn:
                  failed: true
                arguments:
                  parameters:
                    - name: THOTH_DEPENDENCY_MONKEY_JOB_ID
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_JOB_ID}}"
                    - name: THOTH_DOCUMENT_ID
                      value: "{{workflow.parameters.THOTH_DOCUMENT_ID}}"
                    - name: THOTH_LOG_ADVISER
                      value: "{{workflow.parameters.THOTH_LOG_ADVISER}}"
                    - name: THOTH_ADVISER_PLOT
                      value: "{{workflow.parameters.THOTH_ADVISER_PLOT}}"
                    - name: THOTH_ADVISER_BEAM_WIDTH
                      value: "{{workflow.parameters.THOTH_ADVISER_BEAM_WIDTH}}"
                    - name: THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_STACK_OUTPUT}}"
                    - name: THOTH_DEPENDENCY_MONKEY_SEED
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_SEED}}"
                    - name: THOTH_ADVISER_DEV
                      value: "{{workflow.parameters.THOTH_ADVISER_DEV}}"
                    - name: THOTH_DEPENDENCY_MONKEY_DECISION_TYPE
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_DECISION_TYPE}}"
                    - name: THOTH_DEPENDENCY_MONKEY_DRY_RUN
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_DRY_RUN}}"
                    - name: THOTH_ADVISER_PREDICTOR
                      value: "{{workflow.parameters.THOTH_ADVISER_PREDICTOR}}"
                    - name: THOTH_ADVISER_PREDICTOR_CONFIG
                      value: "{{workflow.parameters.THOTH_ADVISER_PREDICTOR_CONFIG}}"
                    - name: THOTH_DEPENDENCY_MONKEY_COUNT
                      value: "{{workflow.parameters.THOTH_DEPENDENCY_MONKEY_COUNT}}"
                    - name: THOTH_ADVISER_LIMIT_LATEST_VERSIONS
                      value: "{{workflow.parameters.THOTH_ADVISER_LIMIT_LATEST_VERSIONS}}"
                    - name: THOTH_S3_ENDPOINT_URL
                      value: "{{workflow.parameters.ceph_host}}"
                    - name: THOTH_CEPH_BUCKET_NAME
                      value: "{{workflow.parameters.ceph_bucket_name}}"
                    - name: THOTH_CEPH_BUCKET_PREFIX
                      value: "{{workflow.parameters.ceph_bucket_prefix}}"
                    - name: THOTH_DEPLOYMENT_NAME
                      value: "{{workflow.parameters.deployment_name}}"
              - name: "graph-sync-dm"
                dependencies:
                  - "dm"
                templateRef:
                  name: "graph-sync"
                  template: "graph-sync"
                arguments:
                  artifacts:
                    - name: outputdocument
                      from: "{{tasks.dm.outputs.artifacts.outputdocument}}"
                  parameters:
                    - name: "THOTH_DOCUMENT_ID"
                      value: "{{workflow.parameters.THOTH_DOCUMENT_ID}}"
                    - name: "THOTH_FORCE_SYNC"
                      value: "1"
