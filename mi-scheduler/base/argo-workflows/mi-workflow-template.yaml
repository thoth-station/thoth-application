apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: mi
  labels:
    app: mi

spec:
  serviceAccountName: argo
  entrypoint: mi-workflow

  templates:
    - name: mi-workflow
      inputs:
        parameters:
          - name: REPOSITORY
          - name: IMAGE_STREAM_REGISTRY
          - name: IMAGE_STREAM_NAMESPACE
          - name: IMAGE_STREAM_TAG
      steps:
        - - name: collect-knowledge
            template: analyse
            arguments:
              parameters:
                - name: REPOSITORY
                  value: "{{inputs.parameters.REPOSITORY}}"
                - name: IMAGE_STREAM_REGISTRY
                  value: "{{inputs.parameters.IMAGE_STREAM_REGISTRY}}"
                - name: IMAGE_STREAM_NAMESPACE
                  value: "{{inputs.parameters.IMAGE_STREAM_NAMESPACE}}"
                - name: IMAGE_STREAM_TAG
                  value: "{{inputs.parameters.IMAGE_STREAM_TAG}}"

        - - name: process-information
            template: process
            arguments:
              parameters:
                - name: REPOSITORY
                  value: "{{inputs.parameters.REPOSITORY}}"
                - name: IMAGE_STREAM_REGISTRY
                  value: "{{inputs.parameters.IMAGE_STREAM_REGISTRY}}"
                - name: IMAGE_STREAM_NAMESPACE
                  value: "{{inputs.parameters.IMAGE_STREAM_NAMESPACE}}"
                - name: IMAGE_STREAM_TAG
                  value: "{{inputs.parameters.IMAGE_STREAM_TAG}}"

    - name: analyse
      inputs:
        parameters:
          - name: REPOSITORY
          - name: IMAGE_STREAM_REGISTRY
          - name: IMAGE_STREAM_NAMESPACE
          - name: IMAGE_STREAM_TAG
      container:
        image: "mi:latest"
        command: ["srcopsmetrics/cli.py"]
        args: ["-cr", "{{inputs.parameters.REPOSITORY}}"]
        env:
          - name: GITHUB_ACCESS_TOKEN
            valueFrom:
              secretKeyRef:
                name: sesheta-srcops
                key: github-access-token
          - name: S3_ENDPOINT_URL
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: host
          - name: CEPH_BUCKET
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: bucket-name
          - name: CEPH_BUCKET_PREFIX
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: bucket-prefix
          - name: CEPH_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: ceph
                key: secret-key
          - name: CEPH_KEY_ID
            valueFrom:
              secretKeyRef:
                name: ceph
                key: key-id
          - name: PYTHONPATH
            value: "."

    - name: process
      inputs:
        parameters:
          - name: REPOSITORY
          - name: IMAGE_STREAM_REGISTRY
          - name: IMAGE_STREAM_NAMESPACE
          - name: IMAGE_STREAM_TAG
      container:
        image: "mi:latest"
        command: ["srcopsmetrics/cli.py"]
        args: ["-pr", "{{inputs.parameters.REPOSITORY}}"]
        env:
          - name: GITHUB_ACCESS_TOKEN
            valueFrom:
              secretKeyRef:
                name: sesheta-srcops
                key: github-access-token
          - name: S3_ENDPOINT_URL
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: host
          - name: CEPH_BUCKET
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: bucket-name
          - name: CEPH_BUCKET_PREFIX
            valueFrom:
              configMapKeyRef:
                name: ceph
                key: bucket-prefix
          - name: CEPH_SECRET_KEY
            valueFrom:
              secretKeyRef:
                name: ceph
                key: secret-key
          - name: CEPH_KEY_ID
            valueFrom:
              secretKeyRef:
                name: ceph
                key: key-id
          - name: PYTHONPATH
            value: "."
