apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: si-cloc
  annotations:
    description: "Thoth: SI-CLOC"
    openshift.io/display-name: "Thoth: SI-CLOC"
    version: 0.7.0
    tags: thoth,ai-stacks,si-cloc
    template.openshift.io/documentation-url: https://github.com/Thoth-Station/
    template.openshift.io/long-description: >
      This template defines resources needed to count lines of code of a python package.
    template.openshift.io/provider-display-name: "Red Hat, Inc."
  labels:
    app: thoth
    template: si-cloc
    component: si-cloc
objects:
  - apiVersion: argoproj.io/v1alpha1
    kind: Workflow
    metadata:
      labels:
        app: thoth
        component: si-cloc
      name: "${THOTH_SI_CLOC_JOB_ID}"
    spec:
      arguments:
        parameters:
          - name: THOTH_SI_CLOC_JOB_ID
            value: "${THOTH_SI_CLOC_JOB_ID}"
          - name: THOTH_DOCUMENT_ID
            value: "${THOTH_SI_CLOC_JOB_ID}"
          - name: THOTH_SI_CLOC_PACKAGE_NAME
            value: "${THOTH_SI_CLOC_PACKAGE_NAME}"
          - name: THOTH_SI_CLOC_PACKAGE_VERSION
            value: "${THOTH_SI_CLOC_PACKAGE_VERSION}"
          - name: THOTH_SI_CLOC_PACKAGE_INDEX
            value: "${THOTH_SI_CLOC_PACKAGE_INDEX}"
          - name: ceph_bucket_prefix
          - name: ceph_bucket_name
          - name: ceph_host
          - name: deployment_name
      entrypoint: si-cloc
      serviceAccountName: argo
      templates:
        - archiveLocation:
            archiveLogs: true
          name: si-cloc
          steps:
            - - arguments:
                  parameters:
                    - name: THOTH_SI_CLOC_JOB_ID
                      value: "{{workflow.parameters.THOTH_SI_CLOC_JOB_ID}}"
                    - name: THOTH_DOCUMENT_ID
                      value: "{{workflow.parameters.THOTH_DOCUMENT_ID}}"
                    - name: THOTH_SI_CLOC_PACKAGE_NAME
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_NAME}}"
                    - name: THOTH_SI_CLOC_PACKAGE_VERSION
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_VERSION}}"
                    - name: THOTH_SI_CLOC_PACKAGE_INDEX
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_INDEX}}"
                    - name: THOTH_S3_ENDPOINT_URL
                      value: "{{workflow.parameters.ceph_host}}"
                    - name: THOTH_CEPH_BUCKET_NAME
                      value: "{{workflow.parameters.ceph_bucket_name}}"
                    - name: THOTH_CEPH_BUCKET_PREFIX
                      value: "{{workflow.parameters.ceph_bucket_prefix}}"
                    - name: THOTH_DEPLOYMENT_NAME
                      value: "{{workflow.parameters.deployment_name}}"
                name: cloc
                templateRef:
                  name: cloc
                  template: cloc
      volumes:
        - emptyDir: {}
          name: workdir
parameters:
  - name: THOTH_SI_CLOC_JOB_ID
    displayName: si-cloc id
    description: A unique dentifier of CLOC security indicator job.
    required: true
  - name: THOTH_SI_CLOC_PACKAGE_NAME
    displayName: package name
    description: Name of package which is being analyzed.
    required: true
  - name: THOTH_SI_CLOC_PACKAGE_VERSION
    displayName: package version
    description: Version of the package being analyzed.
    required: true
  - name: THOTH_SI_CLOC_PACKAGE_INDEX
    displayName: package Index
    description: Index to get package from.
    required: true
