apiVersion: template.openshift.io/v1
kind: Template
metadata:
  name: si-cloc
  annotations:
    description: "Thoth: SI-CLOC"
    openshift.io/display-name: "Thoth: SI-CLOC"
    tags: thoth,ai-stacks,si-cloc
    template.openshift.io/documentation-url: https://github.com/Thoth-Station/
    template.openshift.io/long-description: >
      This template defines resources needed to count lines of code of a python package.
    template.openshift.io/provider-display-name: "Red Hat, Inc."
  labels:
    app: thoth
    template: si-cloc
    component: si-cloc

parameters:
  - name: THOTH_SI_CLOC_JOB_ID
    required: true
    description: A unique dentifier of CLOC security indicator job.
    displayName: si-cloc id
  - name: THOTH_SI_CLOC_PACKAGE_NAME
    required: true
    description: Name of package which is being analyzed.
    displayName: package name
  - name: THOTH_SI_CLOC_PACKAGE_VERSION
    required: true
    description: Version of the package being analyzed.
    displayName: package version
  - name: THOTH_SI_CLOC_PACKAGE_INDEX
    required: true
    description: Index to get package from.
    displayName: package Index

objects:
  - apiVersion: argoproj.io/v1alpha1
    kind: Workflow
    metadata:
      name: "${THOTH_SI_CLOC_JOB_ID}"
      labels:
        app: thoth
        component: si-cloc
    spec:
      serviceAccountName: argo
      entrypoint: si-cloc
      arguments:
        parameters:
          - name: THOTH_SI_CLOC_JOB_ID
            value: "${THOTH_SI_CLOC_JOB_ID}"
          - name: THOTH_DOCUMENT_ID
            value: "${THOTH_SI_CLOC_JOB_ID}"
          - name: THOTH_SI_CLOC_PACKAGE_NAME
            value: "${THOTH_SI_CLOC_PACKAGE_NAME}"
          - name: THOTH_SI_CLOC_PACKAGE_VERSION
            value: "${THOTH_SI_CLOC_PACKAGE_VERSION}"
          - name: THOTH_SI_CLOC_PACKAGE_INDEX
            value: "${THOTH_SI_CLOC_PACKAGE_INDEX}"
          - name: ceph_bucket_prefix
          - name: ceph_bucket_name
          - name: ceph_host
          - name: deployment_name

      volumes:
        - name: workdir
          emptyDir: {}

      templates:
        - name: "si-cloc"
          archiveLocation:
            archiveLogs: true
          steps:
            - - name: cloc
                templateRef:
                  name: "cloc"
                  template: "cloc"
                arguments:
                  parameters:
                    - name: "THOTH_SI_CLOC_JOB_ID"
                      value: "{{workflow.parameters.THOTH_SI_CLOC_JOB_ID}}"
                    - name: "THOTH_DOCUMENT_ID"
                      value: "{{workflow.parameters.THOTH_DOCUMENT_ID}}"
                    - name: "THOTH_SI_CLOC_PACKAGE_NAME"
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_NAME}}"
                    - name: "THOTH_SI_CLOC_PACKAGE_VERSION"
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_VERSION}}"
                    - name: "THOTH_SI_CLOC_PACKAGE_INDEX"
                      value: "{{workflow.parameters.THOTH_SI_CLOC_PACKAGE_INDEX}}"
                    - name: "THOTH_S3_ENDPOINT_URL"
                      value: "{{workflow.parameters.ceph_host}}"
                    - name: "THOTH_CEPH_BUCKET_NAME"
                      value: "{{workflow.parameters.ceph_bucket_name}}"
                    - name: "THOTH_CEPH_BUCKET_PREFIX"
                      value: "{{workflow.parameters.ceph_bucket_prefix}}"
                    - name: "THOTH_DEPLOYMENT_NAME"
                      value: "{{workflow.parameters.deployment_name}}"
